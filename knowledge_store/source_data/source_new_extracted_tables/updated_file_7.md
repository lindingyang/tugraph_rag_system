# TuGraph-Restful-Server

> TuGraph Restful Server 强依赖 TuGraph，Restful Server 与 Tugraph 共存

## 1.TuGraph-Restful-Server 简介
TuGraph Restful Server 使用brpc框架支持的http协议，提供restful接口查询功能，在实现中，restful server 与rpc server 使用同一个端口。目前restful接口提供文件上传，数据导入，导入进度查询，cypher查询，文件删除等功能

## 2.启动 TuGraph-Restful-Server
需要在启动Tugraph时设置enable_rpc参数为true的方式，正常启动TuGraph

## 3.连接 TuGraph-Restful-Server
TuGraph正常启动后，Restful Server 将监听在rpc_port上， 通过访问 http://${ip}:${rpc_port}/LGraphHttpService/Query/ url可以链接到TuGraph

## 4.数据格式
客户端与服务端数据交互的格式是 JSON。在发送请求时，请将发送数据的请求的报头设置为 `Accept:application/json, Content-Type:application/json`。
例如在创建一个点时，请求报头包含以下内容：

```
    Accept: application/json; charset=UTF-8
    Content-Type: application/json
    server_version: 12
```

## 5.返回值

通用返回格式

|  body参数  | 参数说明  |  参数类型  |  是否必填  |
|:--------:|:-----:|:------:| :-----: |
| errorCode |  状态码  |  字符串  |  是  |
| errorMessage | 错误信息  |  字符串  |  是  |
| data | 返回的数据 |  字符串  |  是  |
表格内容描述: 

该表格包含四列，分别为“body参数”、“参数说明”、“参数类型”和“是否必填”。

逐行描述表格中的数据内容：
1. 第一行的数据为：body参数为“errorCode”，参数说明为“状态码”，参数类型为“字符串”，是否必填为“是”。
2. 第二行的数据为：body参数为“errorMessage”，参数说明为“错误信息”，参数类型为“字符串”，是否必填为“是”。
3. 第三行的数据为：body参数为“data”，参数说明为“返回的数据”，参数类型为“字符串”，是否必填为“是”。

总体总结：该表格列举了三个必填的参数，分别为状态码、错误信息和返回的数据，所有参数均为字符串类型。这些参数在提供响应时具有重要的作用。

TuGraph 返回的 HTTP 状态码包含以下四种：

- 200 OK: 操作成功
- 400 Bad Request: 输入有误，例如 URI 错误，或者请求中的 JSON 参数错误
- 401 Unauthorized: 未通过鉴权认证，例如用户名密码错误，token超过有效期等
- 500 Internal Server Error: 服务器端错误
  当操作成功时，返回的 data 中包含操作的返回值。
  当发生输入错误或者服务器错误时，返回的 errorMessage 中包含错误提示。

## 6.URI格式

| URI               | 说明                 |
|-------------------|--------------------|
| /cypher           | 执行cypher查询请求       |
| /refresh          | 刷新token请求          |
| /login            | 用户登陆请求             |
| /logout           | 用户登出请求             |
| /upload_files     | 上传文件请求             |
| /clear_cache      | 清理用户上传文件请求         |
| /check_file       | 文件认证请求             |
| /import_data      | 数据导入请求             |
| /import_progress  | 导入进度查询请求           |
| /import_schema    | 批量创建schema请求       |
表格内容描述: 此表格列出了两列数据：第一列为URI，第二列为说明。每一行分别对应一个特定的请求类型及其描述。 

1. 第一行：URI为"/cypher"，说明是执行cypher查询请求。
2. 第二行：URI为"/refresh"，说明是刷新token请求。
3. 第三行：URI为"/login"，说明是用户登陆请求。
4. 第四行：URI为"/logout"，说明是用户登出请求。
5. 第五行：URI为"/upload_files"，说明是上传文件请求。
6. 第六行：URI为"/clear_cache"，说明是清理用户上传文件请求。
7. 第七行：URI为"/check_file"，说明是文件认证请求。
8. 第八行：URI为"/import_data"，说明是数据导入请求。
9. 第九行：URI为"/import_progress"，说明是导入进度查询请求。
10. 第十行：URI为"/import_schema"，说明是批量创建schema请求。

总体来说，该表格提供了有关API请求的URI及其相应说明，涵盖了从用户认证到文件管理和数据导入等多个功能，帮助用户理解各个请求的用途。

## 7.接口
### 7.1 用户登陆
用于用户第一次与服务端通信时的鉴权操作，请求报文在 http body 中携带用户名和密码，响应报文在 http body 中会返回一个带有有效期的token，后续请求中需要在http header中携带该token作为凭证
#### 7.1.1 URL
http://${ip}:${rpc_port}/LGraphHttpService/Query/login
#### 7.1.2 REQUEST
|  body参数  |  参数说明  |  参数类型  |  是否必填  |
|:--------:|:------:|:------:| :-----: |
表格内容描述: 

该表格包含四个列名：`body参数`、`参数说明`、`参数类型`和`是否必填`。

目前表格为空，没有具体的数据内容可供描述。

综上所述，此表格的结构为一个参数配置表，但由于缺少数据，无法提供具体的参数信息或说明。
 | userName |  用户名  |  字符串  |  是  |
 | password |   密码   |  字符串  |  是  |
#### 7.1.3 RESPONSE
|    body参数     | 参数说明  |  参数类型  |  是否必填  |
|:-------------:|:-----:|:------:| :-----: |
| authorization | token |  字符串  |  是  |
表格内容描述: 表格包含四个列名，分别是"body参数"、"参数说明"、"参数类型"和"是否必填"。表格中仅有一行数据，具体内容为：参数"authorization"的说明为"token"，其类型为"字符串"，并且该参数是必填项。总体来看，该表格明确了一个名为"authorization"的必填字符串参数，其用途是用于传递令牌。

### 7.2 刷新token
token到期后将无法使用此token与服务端正常通信，需要获取新的token作为后续请求的凭证，请求报文在http header中携带旧的token，响应报文在http body中返回新的token
#### 7.2.1 URL
http://${ip}:${rpc_port}/LGraphHttpService/Query/refresh
#### 7.2.2 REQUEST
|   header参数    |  参数说明   |  参数类型  |  是否必填  |
|:-------------:|:-------:|:------:| :-----: |
| Authorization | 旧的token |  字符串  |  是  |
表格内容描述: 该表格包含四列，分别为“header参数”、“参数说明”、“参数类型”和“是否必填”。

第一行数据为：
- “Authorization”：表示旧的token；
- “字符串”：表明该参数的数据类型；
- “是”：表示该参数是必填项。

整体而言，该表格用于描述一个名为“Authorization”的参数，提供了该参数的说明、类型以及是否为必填项的信息。
表格内容描述：该表格包含四列，分别是“header参数”、“参数说明”、“参数类型”和“是否必填”。

在第一行中，header参数为“Authorization”，其参数说明为“旧的token”，参数类型为“字符串”，并且该参数是“必填”的。

总结：此表格描述了一个名为“Authorization”的header参数，它是字符串类型且必须提供，代表旧的token。

#### 7.2.3 RESPONSE
|    body参数     |  参数说明   |  参数类型  |  是否必填  |
|:-------------:|:-------:|:------:| :-----: |
| authorization | 新的token |  字符串  |  是  |
表格内容描述: 该表格包含四列，分别为“body参数”、“参数说明”、“参数类型”和“是否必填”。

在数据内容方面：
- 第一行显示的body参数为“authorization”，其参数说明为“新的token”，参数类型为“字符串”，并且该参数是必填项。

总结：该表格详细描述了一个必填的body参数“authorization”，它的类型为字符串，表示一个新的token。

### 7.3 用户登出
用户不再需要与服务端进行通信时，需要请求登出接口，释放自己的token。请求报文在http header中携带旧的token，如果拿到返回errorCode为200的响应报文即为正常登出
#### 7.3.1 URL
http://${ip}:${rpc_port}/LGraphHttpService/Query/logout
#### 7.3.2 REQUEST
|   header参数    |  参数说明   |  参数类型  |  是否必填  |
|:-------------:|:-------:|:------:| :-----: |
| Authorization | 旧的token |  字符串  |  是  |

### 7.4 执行cypher查询请求
用户通过此类请求发cypher给server端执行并获取执行结果，请求报文在http body 中将执行的cypher语句和目标子图发送给server，server执行完成后在响应报文的http body中返回执行结果
#### 7.4.1 URL
http://${ip}:${rpc_port}/LGraphHttpService/Query/cypher

#### 7.4.2 REQUEST
| body参数 |    参数说明    |  参数类型  |  是否必填  |
|:------:|:----------:|:------:| :-----: |
| graph  |   查询目标子图   |  字符串  |  是  |
| script | cypher查询语句 |  字符串  |  是  |
表格内容描述: 
该表格包含四个列名，分别为“body参数”、“参数说明”、“参数类型”和“是否必填”。 

- 第一行数据为“graph”，其参数说明为“查询目标子图”，参数类型为“字符串”，并且为必填项。
- 第二行数据为“script”，其参数说明为“cypher查询语句”，参数类型同样为“字符串”，并且也是必填项。

总体来看，该表格列出了两个必填的参数，分别是“graph”和“script”，它们用于进行查询时的具体说明和要求。

#### 7.4.3 RESPONSE
|    body参数     |  参数说明   |  参数类型  |  是否必填  |
|:-------------:|:-------:|:------:| :-----: |
| result | 返回结果 |  字符串  |  是  |
表格内容描述: 
该表格包含四列，分别是“body参数”、“参数说明”、“参数类型”和“是否必填”。 

第一行数据为：
- body参数为“result”，其参数说明是“返回结果”，参数类型为“字符串”，并且这是一个必填项。

整体来看，该表格仅包含一项参数信息，说明在接口请求中必须提供一个名为“result”的字符串类型的参数，用于返回结果。

### 7.5 上传文件请求
用户通过此类请求向server发送文件，可以对文件进行分片，分片大小不大于1MB，支持多线程乱序发送，请求报文在http header 中包含文件名，第一字节内容在文件中的偏移和分片大小，在body中包含文件内容，server收到请求后将验证分片大小是否与分片内容一致，一致时将文件分段写入文件。不一致时将返回errorCode为400的响应
#### 7.5.1 URL
http://${ip}:${rpc_port}/LGraphHttpService/Query/upload_files

#### 7.5.2 REQUEST
| header参数  |    参数说明    |  参数类型  |  是否必填  |
|:---------:|:----------:|:------:| :-----: |
| File-Name |   文件名   |  字符串  |  是  |
| Begin-Pos | 开始位置在文件内的偏移 |  字符串  |  是  |
|   Size    | 文件分片大小 |  字符串  |  是  |
|  body参数   |  参数说明   |  参数类型  |  是否必填  |
|     -     | 文件内容 |  字符串  |  是  |
表格内容描述:

该表格包含了两组参数的说明，分别为"header参数"和"body参数"。每组参数均有四列，分别是“参数名称”，“参数说明”，“参数类型”和“是否必填”。

逐行描述表格中的数据内容：
1. 对于"header参数"部分：
   - 文件名（File-Name）：此参数表示文件的名称，类型为字符串，且为必填项。
   - 开始位置（Begin-Pos）：表示文件内的偏移开始位置，类型为字符串，且为必填项。
   - 文件分片大小（Size）：表示文件的分片大小，类型为字符串，且为必填项。

2. 对于"body参数"部分：
   - 文件内容（-）：此参数用于表示文件的实际内容，类型为字符串，且为必填项。

总结：
本表格详细列出了两个参数组，其中"header参数"涉及与文件相关的重要信息，均为必填项，"body参数"则专注于文件内容的传递。所有参数均以字符串类型呈现，确保了数据交换的规范性和一致性。

### 7.6 文件认证请求
用户通过此类请求验证发送到server端的文件是否与期望一致，server端使用两种验证方式，md5值和文件长度，目前已支持文件长度验证。
#### 7.6.1 URL
http://${ip}:${rpc_port}/LGraphHttpService/Query/check_file
#### 7.6.2 REQUEST
|  body参数  |          参数说明           |  参数类型  |  是否必填  |
|:--------:|:-----------------------:|:------:| :-----: |
| fileName |           文件名           |  字符串  |  是  |
| checkSum |        文件对应md5值         |  字符串  |  否  |
| fileSize |       文件长度(以字节计算)       |  字符串  |  否  |
| flag | 标记位，为1时校验md5值，为2时校验文件长度 |  字符串  |  是  |
表格内容描述:
该表格包含四列，分别是“body参数”、“参数说明”、“参数类型”和“是否必填”。 

- 第一行数据是：文件名（fileName），参数类型为字符串，且是必填项。
- 第二行数据是：文件对应md5值（checkSum），参数类型为字符串，非必填项。
- 第三行数据是：文件长度（以字节计算）（fileSize），参数类型为字符串，非必填项。
- 第四行数据是：标记位（flag），说明为当值为1时校验md5值，为2时校验文件长度，参数类型为字符串，且是必填项。

整体总结：该表格列出了与文件相关的参数，包括文件名、md5值、文件长度以及标记位。其中，文件名和标记位是必填项，而md5值和文件长度则为可选项。

#### 7.6.3 RESPONSE
|    body参数     |  参数说明   |  参数类型  |  是否必填  |
|:-------------:|:-------:|:------:| :-----: |
| pass | 检查成功为true，否则为false |  bool  |  是  |
表格内容描述: 该表格包含四列，分别是“body参数”、“参数说明”、“参数类型”和“是否必填”。

在表格的第一行，列出了一个参数“pass”，其参数说明为“检查成功为true，否则为false”。该参数的类型为“bool”，并且是一个必填参数。

总体来看，该表格主要描述了一个必填的布尔型参数“pass”，用于指示检查是否成功。

### 7.7 批量创建schema请求
用户通过此类请求批量创建schema，请求报文在http body 中将创建schema的目标子图和schema信息发送给server，如果拿到返回errorCode为200的响应报文即为正常创建
#### 7.7.1 URL
http://${ip}:${rpc_port}/LGraphHttpService/Query/import_schema
#### 7.7.2 REQUEST
|  body参数  |    参数说明    |  参数类型  |  是否必填  |
|:--------:|:----------:|:------:| :-----: |
| graph |   创建目标子图   |  字符串  |  是  |
| schema | schema描述信息 |  字符串  |  是  |
表格内容描述: 

该表格包含四列，分别为“body参数”、“参数说明”、“参数类型”和“是否必填”。 

第一行数据为“graph”，其参数说明为“创建目标子图”，参数类型为“字符串”，并且该参数是必填的。 

第二行数据为“schema”，其参数说明为“schema描述信息”，参数类型同样为“字符串”，该参数也是必填的。 

总体而言，该表格列出了两个必填的字符串类型参数，分别用于创建目标子图和描述schema的相关信息。

### 7.8 数据导入请求
用户通过此类请求导入已经上传的数据文件。导入不论成功或失败，都将删除已上传文件。数据导入请求在server中实现为一个异步任务，响应返回并不意味着导入已完成，返回的是任务id，后续可以通过此任务id查询导入进度
#### 7.8.1 URL
http://${ip}:${rpc_port}/LGraphHttpService/Query/import_data
#### 7.8.2 REQUEST
|  body参数  |          参数说明           |  参数类型  | 是否必填 |
|:--------:|:-----------------------:|:------:|:----:|
| graph |         导入目标子图          |  字符串  |  是   |
| schema |       导入schema描述        | json字符串  |  是   |
| delimiter |           分隔符           |  字符串  |  是   |
| continueOnError |     单行数据出错是否跳过错误并继续     |  boolean  |  否   |
| skipPackages |         跳过的包个数          |  字符串  |  否   |
| taskId |  任务id   |  字符串  |  否   |
| other | 其他参数 |  json字符串  |  否   |
表格内容描述：
该表格包含四列，分别为“body参数”、“参数说明”、“参数类型”和“是否必填”。

逐行描述如下：
1. **graph**：该参数用于导入目标子图，类型为字符串，必填。
2. **schema**：此参数用于导入schema描述，类型为json字符串，必填。
3. **delimiter**：代表分隔符，类型为字符串，必填。
4. **continueOnError**：用于指示单行数据出错时是否跳过错误并继续，类型为boolean，非必填。
5. **skipPackages**：指跳过的包个数，类型为字符串，非必填。
6. **taskId**：表示任务id，类型为字符串，非必填。
7. **other**：用于其他参数，类型为json字符串，非必填。

总结：该表格列出了与数据导入相关的多个参数，包括必填和非必填选项，共有七个参数，涵盖了数据导入的目标、格式和处理方式等信息。

#### 7.8.3 RESPONSE
|    body参数     |  参数说明   |  参数类型  |  是否必填  |
|:-------------:|:-------:|:------:| :-----: |
| taskId | 任务编号 |  字符串  |  是  |
表格内容描述: 该表格包含四列，分别是“body参数”、“参数说明”、“参数类型”和“是否必填”。

- 第一行数据中，body参数为“taskId”，参数说明为“任务编号”，参数类型为“字符串”，并且该参数为必填项。
  
整体来看，该表格仅包含一项参数信息，主要描述了“taskId”作为必填的字符串类型参数，用于标识任务编号。

### 7.9 清理用户上传文件请求
用户通过此类请求清理已经上传的文件，如果拿到返回errorCode为200的响应报文即为正常清理
#### 7.9.1 URL
http://${ip}:${rpc_port}/LGraphHttpService/Query/clear_cache
#### 7.9.2 REQUEST
|  body参数  |    参数说明    |  参数类型  |  是否必填  |
|:--------:|:----------:|:------:| :-----: |
| fileName |    文件名称    |  字符串  |  否  |
| userName |    用户名称    |  字符串  |  否  |
| flag | 标记位， flag = 0时删除fileName指定文件, flag = 1时删除userName指定用户已经上传的所有文件， flag = 2时删除所有用户上传的文件 |  字符串  |  是  |
表格内容描述：
该表格包含四列，分别是“body参数”、“参数说明”、“参数类型”和“是否必填”。

- 第一行数据：  
  - body参数为“fileName”，  
  - 参数说明为“文件名称”，  
  - 参数类型为“字符串”，  
  - 是否必填为“否”。

- 第二行数据：  
  - body参数为“userName”，  
  - 参数说明为“用户名称”，  
  - 参数类型为“字符串”，  
  - 是否必填为“否”。

- 第三行数据：  
  - body参数为“flag”，  
  - 参数说明为“标记位，flag = 0时删除fileName指定文件，flag = 1时删除userName指定用户已经上传的所有文件，flag = 2时删除所有用户上传的文件”，  
  - 参数类型为“字符串”，  
  - 是否必填为“是”。

总体而言，该表格主要描述了三个参数的特性，其中“flag”参数是必填的，而“fileName”和“userName”则为可选参数。这些参数用于操作文件删除的相关功能。

### 7.10. 导入进度查询请求
用户通过此类请求获得导入任务的状态
#### 7.10.1 URL
http://${ip}:${rpc_port}/LGraphHttpService/Query/import_progress
#### 7.10.2 REQUEST
|  body参数  |          参数说明           |  参数类型  |  是否必填  |
|:--------:|:-----------------------:|:------:| :-----: |
| taskId |           任务编号           |  字符串  |  是  |
表格内容描述: 

该表格包含四列，分别为“body参数”、“参数说明”、“参数类型”和“是否必填”。

- 第一行数据为“taskId”，其参数说明为“任务编号”，参数类型为“字符串”，并且是必填项。

整体来看，该表格提供了一个必填的请求体参数，旨在识别和描述特定任务，其唯一标识符为“taskId”。

#### 7.10.3 RESPONSE
| body参数 |                  参数说明                   |  参数类型  |  是否必填  |
|:------:|:---------------------------------------:|:------:| :-----: |
| state  | 状态标记，为0表示准备导入，为1表示导入中，为2表示导入成功，为3表示导入失败 |  字符串  |  是  |
|  progress  |             导入进度，state为1时包含             |  字符串  |  否  |
|  reason  |             失败原因，state为3时包含             |  字符串  |  否  |
表格内容描述:
该表格包含四列，分别是“body参数”、“参数说明”、“参数类型”和“是否必填”。

- 第一行：state，表示状态标记。当其值为0时表示准备导入，1表示导入中，2表示导入成功，3表示导入失败。该参数的类型为字符串，并且是必填项。
- 第二行：progress，表示导入进度，仅在state为1时包含。该参数的类型也是字符串，但不是必填项。
- 第三行：reason，表示失败原因，仅在state为3时包含。该参数同样是字符串类型，也不是必填项。

总体而言，该表格定义了一些与导入过程相关的参数，以及各参数的详细说明、数据类型和是否为必填项的信息。
